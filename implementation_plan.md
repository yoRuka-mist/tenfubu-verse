# 実装計画 - デジタルカードゲーム - アニメーションとロジックの改善

本計画では、AIモードにおけるアニメーションの不具合修正、ゲームロジック（手札上限）の強化、およびUIの改善を行います。

## 概要
- **AI進化アニメーション修正**: AI（CPU）が進化を行う際、アニメーションが再生されず即座に効果が発動する問題を修正し、プレイヤーと同様の視覚体験を提供します。
- **手札枚数制限**: プレイヤーおよびCPUの手札上限を9枚に設定し、上限を超えるドローや生成カードは墓地へ送られる仕様を実装します。
- **UI改善**: 「使用（Play）」ボタンのデザインと配置を改善し、手札展開時に被らないように調整します。

## 詳細タスク

### 1. AI進化アニメーションの修正
- **現状の問題**: `runAiTurn` 内で `EVOLVE` アクションを直接 dispatch しているため、アニメーションイベント (`setEvolveAnimation`) がスキップされている。
- **修正方針**:
    - `runAiTurn` で直接 dispatch するのではなく、`setEvolveAnimation` を呼び出し、アニメーションステートをセットする。
    - `pendingEvolveRef` を拡張し、`playerId` を保持できるようにする（現在は `currentPlayerId` に依存しているため、AIのターンで不具合が起きる）。
    - アニメーション完了後のコールバック (`handleEvolvePhaseChange`) で、`pendingEvolveRef` に保存された `playerId` を使用してアクションを dispatch するようにロジックを変更する。
- **影響範囲**: `GameScreen.tsx` (AIターンロジック, Animation Callback)。

### 2. 手札上限の実装 (Engine)
- **現状**: 手札上限のチェックが一部（GENERATE_CARD等）にしかなく、ドロー時などに制限がない、または単にカードが消滅するだけで墓地に行かない。
- **修正方針**:
    - `DRAW` 効果: 9枚チェックを追加。溢れたら `graveyard.push` し、ログを出力。
    - `GENERATE_CARD` 効果: 既にチェックはあるが、溢れた場合に墓地に送る処理を追加。
    - `RETURN_TO_HAND` 効果: 手札に戻る際、溢れたら墓地へ送る処理を追加。
- **影響範囲**: `engine.ts` (Card Effects)。

### 3. UI改善 (Playボタン)
- **現状**: ボタンが左下にあり、手札展開時に重なる場合がある。デザインが簡素。
- **修正方針**:
    - 配置をプレイヤーターンエリアの中央寄り、手札の上に移動。
    - デザインをプレミアム感のあるグラデーションと影付きに変更。
- **影響範囲**: `GameScreen.tsx` (Use Button rendering)。

## 検証項目
1. **AI戦**:
    - CPUが進化を行う際、カットインアニメーションが再生されること。
    - その後、ステータス上昇と効果が正しく適用されること。
2. **手札制限**:
    - 手札が9枚の状態でドローした際、カードが墓地に置かれ、ログに「上限に達したため墓地へ」と表示されること。
    - バウンス（手札に戻す）効果で溢れた場合も同様に墓地へ行くこと。
3. **リモート対戦**:
    - 相手（リモートプレイヤー）が進化を行った際もアニメーションが同期して再生されること（`isRemote` フラグと `playerId` の連携確認）。

## 追加実装: ビジュアルとログの強化
### 4. ビジュアルエフェクトの最適化
- **白ツバキ**: 攻撃エフェクトを「ICE」に設定し、氷のエフェクトが再生されるようにする。
- **超進化**: ランディングエフェクトやドラッグラインを紫色（Super Evolutionカラー）に統一し、通常進化と差別化する。

### 5. バトルログの詳細化
- **方針**: ゲームの進行状況を詳細にログ出力し、プレイヤーが何が起きたか（ダメージ計算、破壊理由、バリアなど）を正確に把握できるようにする。
- **実装項目**:
    - **ターン進行**: ターン開始時のプレイヤー名表示。
    - **カードプレイ**: プレイしたカード名と対象の表示。
    - **進化**: 進化/超進化の実行ログ。
    - **攻撃処理**: 攻撃宣言、攻撃ダメージ、反撃ダメージ、バリアによる無効化、破壊のログ。
### 6. UIとアニメーションの全体的なブラッシュアップ
- **手札レイアウト**:
    - 閉じた状態の手札を、枚数が多い場合は右端に寄せ、重なりを調整して見やすくする。
    - 手札のカードが画面下部に接地するように配置調整。
- **戦闘アニメーション**:
    - 反撃（カウンター）時のアニメーションを、攻撃側のアニメーションと少し重ねて遅延再生させ、スピード感のある戦闘演出にする。
    - 攻撃ダメージテキストの表示タイミングを調整。
- **特定カードのエフェクト**:
    - 「ルイ・ユー」の攻撃エフェクト（WATER）を追加・適用。
- **ユーザビリティ**:
    - スペルカード使用時は画面振動（シェイク）を行わないように変更。

## 完了 - 2025/12/21 オーディオ・ビジュアルの改善
### 11. オーディオの強化
- **BGMランダム再生**: `Green Misty Mountains.mp3` と `ouka.mp3` が起動時にランダムで選択されるように実装。
- **SE追加 (shot/impact)**: 
    - `shot` アニメーション時に `shot.mp3` と時間差で `hibi.mp3` を再生。
    - `impact` アニメーション時に `panch1.mp3` (前半) と `panch2.mp3` (後半) を再生。
- **ドローSE**: カードが山札から手札に飛ぶ瞬間に `card.mp3` を再生。

### 12. レイアウトの微調整
- **手札の接地**: 閉じた状態の手札 (`translateY = 45`) と展開時 (`translateY = 5`) を調整し、画面下端により近づくように変更。
- **イラスト更新**: 「なゆた」の画像を `nayuta.png` に統一。

## 完了 - 2025/12/18 バグ修正と改善
### 7. 手札インタラクションの修正 (CRITICAL)
- **バグ**: 手札のカードをクリックしても展開されない不具合を解消。
- **原因**: 
    - `handleHandMouseDown` 内の `isHandExpanded` トグルロジックが欠落していた。
    - 手札コンテナの `pointer-events: none` が子要素のクリックを妨げていたため、`pointer-events: auto` をカードに明示的に追加。
    - コンテナの `zIndex` が低く、他の要素に隠れていたのを 3000 に修正。

### 8. AIロジックと型の修復
- **AI回復**: 壊れていた `runAiTurn` 内のブレース構造を修復し、CPUが正常にカードプレイ・攻撃・ターン終了を行うようにした。
- **型エラー解消**: `useVisualBoard` の `instanceId` エラーを解消し、変数の重複宣言を削除。

### 9. 盤面再配置の遅延実装
- **useVisualBoard**: フォロワーが破壊された際、即座に盤面から消さず `isDying` フラグで 1.2秒間表示を維持。ダメージ数字がフェードアウトした後に再配置が行われるように調整。
- **JSX統合**: 実際の盤面 (`player.board`) ではなく `visualPlayerBoard` を map してレンダリングするように変更。

### 10. AIウェイト時間の最適化
- **アニメーションの快適化**: 攻撃後の `waitForIdle` を調整し、カウンターがある場合は 850ms、ない場合は 500ms に短縮してテンポを改善。
