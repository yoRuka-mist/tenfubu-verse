# Implementation Plan - 05_DigitalCardGame (2025-12-18 更新)

## 概要
SEP表現の洗練、カード重複の整理、特定の演出の条件付き発動、カードエフェクトの視認性向上、および新エフェクト 'SHOT' の実装を行います。

## 修正詳細

### 1. カードデータの整理と更新 (engine.ts)
- **SARA削除**: コスト4の `c_sara` 定義を削除し、コスト7の `c_sara` のみを残す。
- **Monoの強化**: 進化時効果 `EVOLVE` を追加。効果種別 `DAMAGE`、威力 5、対象 `SELECT_FOLLOWER`。
- **攻撃エフェクト指定**: Monoの `attackEffectType` を `'SHOT'` に設定。

### 3. カード画像の表示修正

ブラウザエージェントによる調査では、画像自体は正しく読み込まれているものの、特定の状況で表示されない可能性が浮上した。以下の修正を行う。

1.  **`engine.ts` の画像パス統一**:
    -   `imageUrl` が `cards/xxx.jpg` のようになっているものを `/cards/xxx.jpg` に修正。

2.  **`Card.tsx` のレンダリング修正**:
    -   原因: `Card.tsx` のルート要素に `.card` クラスが適用されておらず、CSSで定義された幅（140px）と高さ（200px）が反映されていない。
    -   対策: `className` に `card` を追加。
    -   互換性: `inset: 0` を `top: 0; left: 0; right: 0; bottom: 0;` に置換。
    -   領域確保: `flex: 1` を持つ画像コンテナに対し、`min-height: 0` または具体的な高さを保証する。

3.  **`Card.css` の調整**:
    -   `.card-container` にデフォルトの大きさを設定し、スタイルが渡されない場合でも潰れないようにする。

### 4. その他要件の修正
- Monoの画像パス修正 (`Mono.jpg` -> `/cards/Mono.jpg`)
- 青ツバキのコスト(2->4)とステータス(2/2->4/3)修正
- AIの進化時ターゲット選択ロジックの実装

### 2. ビジュアル。エフェクトの修正 (Card.tsx, GameScreen.tsx)
- **カードエフェクトの階層修正**: `Card.tsx` において、`overflow: hidden` な画像コンテナの外に守護・バリア・オーラのエフェクトを配置するようにJSXを組み直す。
- **SEPの色**: `GameScreen.tsx` の予測線 (`path`) とドラッグ中の円の色を、グローではなく純粋な紫色 (`#9f7aea`) に変更。
- **トークン演出の制限**: `sara` プレイ時のエフェクト処理内で、ターン数が11未満の場合は `animatingCard` のセット（およびSE再生）をスキップする。
- **SHOTエフェクトの実装**: `GameScreen.tsx` 内の `AttackEffect` コンポーネント（または該当箇所）に、IMPACTやSUMIと同様の仕組みで `'SHOT'` アニメーションを追加。
- **相手デッキの配置**: 相手デッキのCSSを調整し、カードの重なりが左下に向かってズレるように修正。

### 3. ロジック修正
- **ダメージエフェクトの起点**: Monoの効果発動時、対象フォロワーの座標で `'SHOT'` エフェクトを発生させるように `GameScreen.tsx` の `handleUseButtonClick` 等を調整。
- **CPU思考ルーチンの改善**:
  - カードプレイ、進化、攻撃の各アクション間に、`pendingEffects` の消化やビジュアルエフェクト (`activeEffects`, `animatingCard`) の完了を待機するロジック (`waitForIdle`) を導入。
  - 効果処理後、ユーザーが状況を把握しやすいように1〜数秒の待機時間を設ける。

### 5. UI/UX改善
- **バトルログ**: 画面右側のメインエリア左端にフローティング表示する `BattleLog` コンポーネントを追加し、ゲームの進行状況 (`gameState.logs`) を可視化する。
- **突進 (RUSH) のハンドリング改善**:
  - **AI（CPU）**: 突進持ちでまだリーダーを攻撃できない状態（場に出たターンかつ疾走を持たない）の場合、ターゲット選択ロジックからリーダーを除外する。
  - **UI（プレイヤー）**: `handleGlobalMouseUp` 内のボードからのドラッグ終了処理（攻撃確定時）において、突進（RUSH）持ちがリーダーを攻撃しようとした場合、ブロック判定を行い、アニメーション及び `dispatch` を実行しないようにする。

### 6. ビジュアル・演出の微調整
- **リーダー位置調整**: プレイヤーおよび相手のリーダーエリア全体の表示位置を `top` プロパティを調整して10px下げる。
- **Sara修正**: テキストを「ソリィ…The end.」から「すみませんが、これで終わりです。」に変更。
- **SEP演出強化**:
  - ドラッグ中の矢印・予測線の色を黄色から紫色 (`#9f7aea`) に変更。
  - 超進化アニメーション (`EvolutionAnimation`) の着地時のパーティクルを紫色に変更。

### 7. バトルログ・演出のさらなる改善 (New)
- **ログの拡充**: `PLAY_CARD`, `ATTACK` アクション時、および `DESTROY` などの効果発生時に、行動の主体やソースとなるカード名をログに含める。
- **リーダー攻撃レスポンス遅延終了**: プレイヤーがリーダーを攻撃した際、即座にダメージを反映せず、攻撃アニメーションの終了を待ってから `dispatch` するように修正（約500ms遅延）。
- **破壊効果のダメージテキスト抑制**: カードが破壊効果で除去された場合、ダメージテキスト（赤い数字）が表示されないように `GameScreen.tsx` の差分監視ロジックを修正。墓地に送られたカードのHP残量を確認して判定する。
- **リーダー位置再調整**: 相手リーダーが見切れないよう、さらに下に移動。
