# 実装計画 - デジタルカードゲーム - アニメーションとロジックの改善

本計画では、AIモードにおけるアニメーションの不具合修正、ゲームロジック（手札上限）の強化、およびUIの改善を行います。

## 概要
- **AI進化アニメーション修正**: AI（CPU）が進化を行う際、アニメーションが再生されず即座に効果が発動する問題を修正し、プレイヤーと同様の視覚体験を提供します。
- **手札枚数制限**: プレイヤーおよびCPUの手札上限を9枚に設定し、上限を超えるドローや生成カードは墓地へ送られる仕様を実装します。
- **UI改善**: 「使用（Play）」ボタンのデザインと配置を改善し、手札展開時に被らないように調整します。

## 詳細タスク

### 1. AI進化アニメーションの修正
- **現状の問題**: `runAiTurn` 内で `EVOLVE` アクションを直接 dispatch しているため、アニメーションイベント (`setEvolveAnimation`) がスキップされている。
- **修正方針**:
    - `runAiTurn` で直接 dispatch するのではなく、`setEvolveAnimation` を呼び出し、アニメーションステートをセットする。
    - `pendingEvolveRef` を拡張し、`playerId` を保持できるようにする（現在は `currentPlayerId` に依存しているため、AIのターンで不具合が起きる）。
    - アニメーション完了後のコールバック (`handleEvolvePhaseChange`) で、`pendingEvolveRef` に保存された `playerId` を使用してアクションを dispatch するようにロジックを変更する。
- **影響範囲**: `GameScreen.tsx` (AIターンロジック, Animation Callback)。

### 2. 手札上限の実装 (Engine)
- **現状**: 手札上限のチェックが一部（GENERATE_CARD等）にしかなく、ドロー時などに制限がない、または単にカードが消滅するだけで墓地に行かない。
- **修正方針**:
    - `DRAW` 効果: 9枚チェックを追加。溢れたら `graveyard.push` し、ログを出力。
    - `GENERATE_CARD` 効果: 既にチェックはあるが、溢れた場合に墓地に送る処理を追加。
    - `RETURN_TO_HAND` 効果: 手札に戻る際、溢れたら墓地へ送る処理を追加。
- **影響範囲**: `engine.ts` (Card Effects)。

### 3. UI改善 (Playボタン)
- **現状**: ボタンが左下にあり、手札展開時に重なる場合がある。デザインが簡素。
- **修正方針**:
    - 配置をプレイヤーターンエリアの中央寄り、手札の上に移動。
    - デザインをプレミアム感のあるグラデーションと影付きに変更。
- **影響範囲**: `GameScreen.tsx` (Use Button rendering)。

## 検証項目
1. **AI戦**:
    - CPUが進化を行う際、カットインアニメーションが再生されること。
    - その後、ステータス上昇と効果が正しく適用されること。
2. **手札制限**:
    - 手札が9枚の状態でドローした際、カードが墓地に置かれ、ログに「上限に達したため墓地へ」と表示されること。
    - バウンス（手札に戻す）効果で溢れた場合も同様に墓地へ行くこと。
3. **リモート対戦**:
    - 相手（リモートプレイヤー）が進化を行った際もアニメーションが同期して再生されること（`isRemote` フラグと `playerId` の連携確認）。
