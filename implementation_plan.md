# 実装計画 - デジタルカードゲーム - UI・ビジュアルのブラッシュアップ

## 完了 - 2025/12/18 UI/UXおよび視覚演出の更なる改善
### 13. 手札展開と選択の挙動修正
- **手札展開アニメーション**: `isHandExpanded`時の`translateY`を`-30`（上へ移動）に調整。コンテナのパディング変更によるレイアウトの「ガタつき」を解消するため、パディングを固定値に修正。
- **展開中の選択更新**: 手札が展開されている状態でも、他のカードをクリックすれば `selectedCard` が即座に更新されるように `handleHandMouseDown` を修正。
- **選択カードのリフトアップ**: 展開中に選択されているカードのみ、さらに`-20px`（合計`-50px`）持ち上げることで、視覚的なフィードバックを強化。

### 14. 設定画面とメニューの改善
- **文字化け修正**: 設定画面内の「BGM再生」「ボイス」などのテキストが文字化け（エンコーディング不良）していたのを、UTF-8文字列に修正。
- **メニューボタン**: ハンバーガーメニューボタンにマージンとパディングを追加し、画面端に寄りすぎないよう調整。
- **全体レイアウトのシフト**: 画面全体が上に寄りすぎていたため、ルート要素に `paddingTop: 40px` を追加して全体を少し下げ、バランスを調整。

### 15. 戦闘・演出の強化
- **SHOTエフェクトのスケーリング**: 弾丸エフェクトが大きすぎたため、`AttackEffect`内の`scale`を `0.75` に縮小。
- **相手の山札の向き**: 遠近感を統一するため、相手の山札の重なり（スタック）をプレイヤーと同じく「右後ろ」に重なるように調整。
- **カード破壊演出**: カードが破壊される際、単に消える・ぼやけるだけでなく、`card-dying` アニメーション（白く発光しながら拡大・回転し、消滅）を実装。

# 実装計画 - デジタルカードゲーム - アニメーションとロジックの改善

本計画では、AIモードにおけるアニメーションの不具合修正、ゲームロジック（手札上限）の強化、およびUIの改善を行います。

## 概要
- **AI進化アニメーション修正**: AI（CPU）が進化を行う際、アニメーションが再生されず即座に効果が発動する問題を修正し、プレイヤーと同様の視覚体験を提供します。
- **手札枚数制限**: プレイヤーおよびCPUの手札上限を9枚に設定し、上限を超えるドローや生成カードは墓地へ送られる仕様を実装します。
- **UI改善**: 「使用（Play）」ボタンのデザインと配置を改善し、手札展開時に被らないように調整します。

## 詳細タスク

### 1. AI進化アニメーションの修正
- **現状の問題**: `runAiTurn` 内で `EVOLVE` アクションを直接 dispatch しているため、アニメーションイベント (`setEvolveAnimation`) がスキップされている。
- **修正方針**:
    - `runAiTurn` で直接 dispatch するのではなく、`setEvolveAnimation` を呼び出し、アニメーションステートをセットする。
    - `pendingEvolveRef` を拡張し、`playerId` を保持できるようにする（現在は `currentPlayerId` に依存しているため、AIのターンで不具合が起きる）。
    - アニメーション完了後のコールバック (`handleEvolvePhaseChange`) で、`pendingEvolveRef` に保存された `playerId` を使用してアクションを dispatch するようにロジックを変更する。
- **影響範囲**: `GameScreen.tsx` (AIターンロジック, Animation Callback)。

### 2. 手札上限の実装 (Engine)
- **現状**: 手札上限のチェックが一部（GENERATE_CARD等）にしかなく、ドロー時などに制限がない、または単にカードが消滅するだけで墓地に行かない。
- **修正方針**:
    - `DRAW` 効果: 9枚チェックを追加。溢れたら `graveyard.push` し、ログを出力。
    - `GENERATE_CARD` 効果: 既にチェックはあるが、溢れた場合に墓地に送る処理を追加。
    - `RETURN_TO_HAND` 効果: 手札に戻る際、溢れたら墓地へ送る処理を追加。
- **影響範囲**: `engine.ts` (Card Effects)。

### 3. UI改善 (Playボタン)
- **現状**: ボタンが左下にあり、手札展開時に重なる場合がある。デザインが簡素。
- **修正方針**:
    - 配置をプレイヤーターンエリアの中央寄り、手札の上に移動。
    - デザインをプレミアム感のあるグラデーションと影付きに変更。
- **影響範囲**: `GameScreen.tsx` (Use Button rendering)。

## 検証項目
1. **AI戦**:
    - CPUが進化を行う際、カットインアニメーションが再生されること。
    - その後、ステータス上昇と効果が正しく適用されること。
2. **手札制限**:
    - 手札が9枚の状態でドローした際、カードが墓地に置かれ、ログに「上限に達したため墓地へ」と表示されること。
    - バウンス（手札に戻す）効果で溢れた場合も同様に墓地へ行くこと。
3. **リモート対戦**:
    - 相手（リモートプレイヤー）が進化を行った際もアニメーションが同期して再生されること（`isRemote` フラグと `playerId` の連携確認）。

## 追加実装: ビジュアルとログの強化
### 4. ビジュアルエフェクトの最適化
- **白ツバキ**: 攻撃エフェクトを「ICE」に設定し、氷のエフェクトが再生されるようにする。
- **超進化**: ランディングエフェクトやドラッグラインを紫色（Super Evolutionカラー）に統一し、通常進化と差別化する。

### 5. バトルログの詳細化
- **方針**: ゲームの進行状況を詳細にログ出力し、プレイヤーが何が起きたか（ダメージ計算、破壊理由、バリアなど）を正確に把握できるようにする。
- **実装項目**:
    - **ターン進行**: ターン開始時のプレイヤー名表示。
    - **カードプレイ**: プレイしたカード名と対象の表示。
    - **進化**: 進化/超進化の実行ログ。
    - **攻撃処理**: 攻撃宣言、攻撃ダメージ、反撃ダメージ、バリアによる無効化、破壊のログ。
### 6. UIとアニメーションの全体的なブラッシュアップ
- **手札レイアウト**:
    - 閉じた状態の手札を、枚数が多い場合は右端に寄せ、重なりを調整して見やすくする。
    - 手札のカードが画面下部に接地するように配置調整。
- **戦闘アニメーション**:
    - 反撃（カウンター）時のアニメーションを、攻撃側のアニメーションと少し重ねて遅延再生させ、スピード感のある戦闘演出にする。
    - 攻撃ダメージテキストの表示タイミングを調整。
- **特定カードのエフェクト**:
    - 「ルイ・ユー」の攻撃エフェクト（WATER）を追加・適用。
- **ユーザビリティ**:
    - スペルカード使用時は画面振動（シェイク）を行わないように変更。

## 完了 - 2025/12/21 オーディオ・ビジュアルの改善
### 11. オーディオの強化
- **BGMランダム再生**: `Green Misty Mountains.mp3` と `ouka.mp3` が起動時にランダムで選択されるように実装。
- **SE追加 (shot/impact)**: 
    - `shot` アニメーション時に `shot.mp3` と時間差で `hibi.mp3` を再生。
    - `impact` アニメーション時に `panch1.mp3` (前半) と `panch2.mp3` (後半) を再生。
- **ドローSE**: カードが山札から手札に飛ぶ瞬間に `card.mp3` を再生。

### 12. レイアウトの微調整
- **手札の接地**: 閉じた状態の手札 (`translateY = 45`) と展開時 (`translateY = 5`) を調整し、画面下端により近づくように変更。
- **イラスト更新**: 「なゆた」の画像を `nayuta.png` に統一。

## 完了 - 2025/12/21 レイヤー構造の再構築とレイアウト安定化
### 16. 絶対配置レイヤー構造の導入
- **3層構造化**: 画面レイアウトを以下の3つの絶対配置レイヤーに厳密に分割し、UI干渉を排除。
    - **Layer 1 (Top 25%)**: 対戦相手エリア（リーダー、手札、デッキ）
    - **Layer 2 (Middle 50%)**: 戦場（プレイエリア）
    ### 3. ゲーム画面レイアウトの刷新（リファクタリング）
- **3層構造による絶対配置**: 画面内要素の干渉を防ぐため、UIを3つの独立したレイヤー（Opponent Layer, Field Layer, Player Layer）に分離。
- **リーダー位置の修正**:
    - 相手リーダー: `Top: 0`, `Left: 50%`. 顔が見切れないようにY座標を調整。
    - 自分リーダー: `Bottom: 0` へ配置変更。UI（HP/EP/SEP）を中央軸に対して完全に対称配置するよう修正。
- **手札の挙動安定化**:
    - `isHandExpanded` ステートによる条件分岐を整理。
    - **Collapsed**: `translateY: 80px`. 画面下に「沈める」ことで、カード上部のみが覗く形にする。
    - **Expanded**: `translateY: 0px`. 画面下端に固定し、アニメーション時の座標計算を簡素化。
    - 手札コンテナを固定高さとし、クリックイベントのバブリングを防止して誤操作を防ぐ。
- **レイアウトシフト対策**:
    - `boardRef` および `GameScreen` コンテナに `overflow: hidden` を適用。
    - `useLayoutEffect` により毎レンダリング時に `scrollTop` を強制リセットし、ブラウザの自動スクロール（フォーカス移動等）による画面ズレを防止。対する `box-sizing: border-box`, `overflow: hidden` を徹底し、ブラウザ間の表示差異とスクロールバー発生を防止。

    - **Layer 3 (Bottom 25%)**: プレイヤーエリア（リーダー、手札、デッキ）
- **グローバルCSSリセット**: `html, body` および `*` に対する `box-sizing: border-box`, `overflow: hidden` を徹底し、ブラウザ間の表示差異とスクロールバー発生を防止。

### 17. 各要素の配置最適化
- **相手リーダー**: `top: -20` に調整し、顔が切れる問題を解消しつつ、自然な位置に配置。
- **プレイヤーリーダー**: `bottom: -150` に設定（旧 -80 から大幅変更）し、画面下部に深く沈み込む配置で安定感を強調。
- **手札**: コンテナの `bottom: 0` アンカーを徹底し、浮き上がりや位置ズレを解消。
- **デッキ**: 各レイヤー内の適切な位置に再配置し、以前の重複レンダリングコードを削除。

## 完了 - 2025/12/18 バグ修正と改善
### 7. 手札インタラクションの修正 (CRITICAL)
- **バグ**: 手札のカードをクリックしても展開されない不具合を解消。
- **原因**: 
    - `handleHandMouseDown` 内の `isHandExpanded` トグルロジックが欠落していた。
    - 手札コンテナの `pointer-events: none` が子要素のクリックを妨げていたため、`pointer-events: auto` をカードに明示的に追加。
    - コンテナの `zIndex` が低く、他の要素に隠れていたのを 3000 に修正。

### 8. AIロジックと型の修復
- **AI回復**: 壊れていた `runAiTurn` 内のブレース構造を修復し、CPUが正常にカードプレイ・攻撃・ターン終了を行うようにした。
- **型エラー解消**: `useVisualBoard` の `instanceId` エラーを解消し、変数の重複宣言を削除。

### 9. 盤面再配置の遅延実装
- **useVisualBoard**: フォロワーが破壊された際、即座に盤面から消さず `isDying` フラグで 1.2秒間表示を維持。ダメージ数字がフェードアウトした後に再配置が行われるように調整。
- **JSX統合**: 実際の盤面 (`player.board`) ではなく `visualPlayerBoard` を map してレンダリングするように変更。

### 10. AIウェイト時間の最適化
- **アニメーションの快適化**: 攻撃後の `waitForIdle` を調整し、カウンターがある場合は 850ms、ない場合は 500ms に短縮してテンポを改善。

## 完了 - 2025/12/21 ゲーム画面UIの最終ブラッシュアップ
### 18. UI要素の対称性と視認性の向上
- **リーダーUIの対称配置**: プレイヤーおよび相手リーダーのHP、EP、SEPを、リーダー画像の中央軸に対して完全に対称に配置。HPを左側、EP/SEPを右側に配置し、UI要素がリーダーの顔を隠しすぎないようオフセット（`140px`, `80px`）を微調整。
- **EP/SEPの視覚的リニューアル**: EPとSEPのテキストラベルを削除し、円形のフレーム内にステータスを表すドットを配置。現代的なデジタルカードゲームのスタイルに統一。
- **右側コントロールの大型化**: プレイの快適性を向上させるため、「ターン終了」ボタンおよびPP表示エリアのサイズを約2倍に拡大。

### 19. 手札とステータス表示の改善
- **手札アイコンとカウンター**: 画面左下に現在の「手札枚数」と「カードスタックアイコン」を統合して配置。手札状況が常時把握可能に。
- **手札のスぺーシング改善**: 非展開時の手札カード間の重なりを緩和し、各カードの視認性を向上（`spacing = Math.min(45, 300 / handSize)`）。
- **接地感の向上**: 展開時・非展開時ともに `translateY: 0` とし、画面下端に安定して配置。

### 20. コードの健全性と安定化
- **クリーンアップ**: `Board Ghost` などの過去の不要なコード断片やコメントを完全に削除。
- **Reactインポート整理**: 未使用の React hook インポート（および欠落していた `useReducer`）を整理し、Lintエラーと警告を解消。
- **レイアウトシフトの根絶**: `useLayoutEffect` によるスクロール位置制御と `overflow: hidden` の徹底により、対戦開始時の画面ズレ問題を解消。
