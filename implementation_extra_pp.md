# エクストラPP実装ドキュメント

## 概要
エクストラPPは、シャドウバース ワールズビヨンドの仕様に基づいた後攻救済システムです。
後攻プレイヤーは、ターン中に+1PPを一時的に獲得できる権利を持ちます。

## 仕様詳細

### 使用条件
- **後攻プレイヤーのみ**使用可能
- **自分のターン中のみ**使用可能
- 1試合につき**最大2回**まで使用可能:
  - 1〜5ターン目の間に**1回**
  - 6ターン目以降に**1回**
- 1〜5ターン目までに使用しなくても、6ターン目以降には持ち越し**不可**

### 効果
- 使用したターンのみPPが+1される
- 次のターンには消滅する（永続的な増加ではない）
- カードをプレイしてPPを消費した後でも有効化可能
- 有効化後にオフにすることも可能（トグル）

## 実装詳細

### 1. types.ts (型定義)

```typescript
// Player型に追加されたフィールド
interface Player {
    // ... 既存フィールド

    // Extra PP (後攻救済システム)
    extraPpUsedEarly: boolean;  // 1~5ターン目で使用済みか
    extraPpUsedLate: boolean;   // 6ターン目以降で使用済みか
    extraPpActive: boolean;     // 現在のターンでエクストラPPを有効化しているか
}

// GameActionに追加
| { type: 'TOGGLE_EXTRA_PP'; playerId: string }
```

### 2. engine.ts (ロジック)

#### createPlayer関数
プレイヤー作成時にエクストラPPフィールドを初期化:
```typescript
extraPpUsedEarly: false,
extraPpUsedLate: false,
extraPpActive: false
```

#### END_TURNアクション
ターン終了時の処理:
- エクストラPPがアクティブな場合、使用済みフラグを更新
- 1〜5ターン目なら`extraPpUsedEarly = true`
- 6ターン目以降なら`extraPpUsedLate = true`
- `extraPpActive`をリセット

#### TOGGLE_EXTRA_PPアクション
新規追加されたアクション:
- 後攻プレイヤーのみ実行可能
- 自分のターンのみ実行可能
- アクティブ時はオフに（PP-1）
- 非アクティブ時はオンに（PP+1）
- 使用可能回数のチェック

### 3. GameScreen.tsx (UI)

#### PP表示の変更
- エクストラPP有効時: `PP/MaxPP +1` 形式で表示
- PP丸表示: 通常PPは黄色、エクストラPPはオレンジで表示
- エクストラPP分の丸にはグロー効果

#### エクストラPPボタン
- 後攻プレイヤーのみ表示
- 使用可能時: オレンジ系のグラデーション背景
- 使用不可時: グレーアウト
- アクティブ時: 強調表示（グロー効果、"ON"表示）

### 4. 通信対戦での同期
- `dispatchAndSend`関数がTOGGLE_EXTRA_PPアクションを自動的に送信
- 相手側でも状態が同期される
- `SYNC_STATE`でゲーム状態全体が同期されるため、エクストラPPの状態も含まれる

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|----------|
| `src/core/types.ts` | Player型にエクストラPPフィールド追加、TOGGLE_EXTRA_PPアクション追加 |
| `src/core/engine.ts` | createPlayer初期化、END_TURN処理、TOGGLE_EXTRA_PPアクション実装 |
| `src/screens/GameScreen.tsx` | PP表示UI変更、エクストラPPボタン追加 |

## 注意点

1. **CPUはエクストラPPを使用しない**
   - 現時点ではプレイヤーのみが使用可能
   - CPU側のAIロジックは未実装

2. **ターンカウントの解釈**
   - turnCountは先攻プレイヤー基準（1から開始）
   - 後攻の5ターン目はturnCount=5の時

3. **トグル機能**
   - 一度有効化しても、カードプレイ前ならオフに戻せる
   - オフにするとPP-1される

## テスト項目

- [ ] 後攻時にエクストラPPボタンが表示される
- [ ] 先攻時にエクストラPPボタンが表示されない
- [ ] 1〜5ターン目でエクストラPPを使用できる
- [ ] 使用後、1〜5ターン目では再使用不可
- [ ] 6ターン目以降でエクストラPPを使用できる
- [ ] 使用後、6ターン目以降では再使用不可
- [ ] エクストラPP有効時にPP+1される
- [ ] ターン終了時にエクストラPPがリセットされる
- [ ] 通信対戦で相手にエクストラPP状態が同期される
- [ ] エクストラPPをトグルでオフにできる
