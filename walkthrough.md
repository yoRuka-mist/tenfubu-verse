# バグ修正の概要

報告された4つのバグ修正を行いました。

## 1. CPU戦で召喚されたカードが攻撃できないバグ (しゑこバグ)
- **原因**: ドラッグ開始時の「攻撃可能か？」の判定が、Propsから渡された古いカードデータを参照していたため、直前に進化して `canAttack` が true になったカードの状態を正しく認識できていませんでした。
- **修正**: ドラッグ開始 (`handleBoardMouseDown`) 時に、`gameStateRef.current` から最新の盤面状態を取得し、その情報に基づいて攻撃判定を行うように修正しました。

## 2. カード情報を表示しようとすると選択が解除されるバグ
- **原因**: 自分のボード上のカードをクリックした際、クリックイベントが親要素に伝播してしまい、背景クリック時の「選択解除処理」が走っていました。
- **修正**: プレイヤーのボードスロットの `onClick` イベントに `e.stopPropagation()` を追加し、イベント伝播を阻止しました。

## 3. 手札のカードが消えるバグ (バックハンドスマッシュ消失)
- **原因**: カードプレイ時のアニメーション中や、エフェクト処理中に次のカードをクリックできてしまうことで、手札インデックスのズレや状態不整合が発生していました。特に0コストスペルを連打した際に発生しやすい問題でした。
- **修正**: 手札をクリックした際、`playingCardAnim` (カードプレイアニメーション中) または `animatingCard` (カード生成アニメーション中) の場合は操作を受け付けないようにガード処理を追加しました。

## 4. 解像度変更時にスペル演出がズレるバグ (再修正)
- **原因**: 前回のエフェクト座標修正で `scale` を適用しましたが、実際にはエフェクトの配置はスクリーン座標（ピクセル等倍）で行われており、`scale` の二重適用や座標系の不一致（論理座標 vs スクリーン座標）が発生していました。
- **修正**: エフェクト座標計算 (`playEffect`) を完全に「スクリーン座標」に統一しました。ターゲットなしの場合は画面中央 (`window.innerWidth/2`) を、ターゲットありの場合は要素の絶対位置 (`getBoundingClientRect`) を使用し、レンダリング時には `scale` を掛けずにそのまま配置するようにしました。これにより、どんなウィンドウサイズでも正しい位置にエフェクトが表示されます。

## 確認方法
- **召喚後の攻撃**: 「白ツバキ」などで召喚されたカードを進化させ、即座に攻撃できることを確認してください。
- **カード情報**: 自分の場のカードをクリックしても、右側の情報パネルが閉じないことを確認してください。
- **カード連打**: 「センカ」デッキなどで0コストスペルを素早くプレイしても、手札が正しく処理されることを確認してください。
- **解像度**: ウィンドウサイズを変更しても、スペルの着弾エフェクトなどが正しい位置に表示されることを確認してください。
