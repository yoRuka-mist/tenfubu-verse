# 修正内容の確認 (Walkthrough) - カードプレイアニメーションの改善

## 修正の概要
カードをプレイした際の、「手札 → 中央（ズームアップ） → 盤面（着地）」というアニメーション一連の流れを改善しました。特に、着地する際の座標を盤面の現在の状況から正確に逆算するようにし、動きを物理的に自然なイーズアウト（減速）に変更しました。

## 主な変更点

### 1. 盤面着地座標の正確な逆算 (`GameScreen.tsx`)
盤面に配置されるカードの現在の枚数と、新しいカードが追加されるインデックスを元に、最終的な `finalX` と `finalY` を計算するロジックを導入しました。
- `spacing = 102` (カード幅90 + 隙間12) を使用し、既存のレンダリングロジックと完全に同期させました。
- プレイヤー側だけでなく、CPU（相手）側のプレイ時や、ターゲット選択が必要なカードのプレイ時にも適用しました。

### 2. アニメーションキーフレームの改善
`playCardSequence` キーフレームを見直し、以下の3フェーズ構成に最適化しました：
- **0-30%**: 手札から中央へ。拡大しながら移動。
- **30-65%**: 中央で大きく表示（ホールド）。カードの内容を確認しやすくしました。
- **65-100%**: 中央から盤面の目標座標へ移動・縮小。

### 3. 滑らかな着地と緩急（メリハリ）の強化
アニメーションのタイミング関数を調整し、さらに各フェーズの時間配分を見直すことで「緩急」をつけました。
- **進化**: 
    - 回転が止まってサイズが縮小する「停滞時間」を完全に削除しました。
    - 代わりに、最後の10度の回転を **1200ms** かけてゆっくり行うことで、カードが最高潮の状態で「溜め」を作るように変更しました。
    - ゆっくりした回転が終わった瞬間、サイズを維持したまま盤面へ **250ms** で一気に収束させ、スナップ感を極限まで高めました。
    - パーティクルサイズを **3倍** に拡大し、周囲の光の帯（リング）を太く、発光も強力に強化しました。

###### 演出シーケンスとオーディオの修正
- **特殊召喚のデッドロック解消**: `GameScreen.tsx` において、Reactの再レンダリングによって効果処理のタイマーが破棄（`clearTimeout`）され、シーケンスが停止していた問題を修正しました。タイマーを `useRef` で管理し、状態更新を跨いでタイマーが継続するようにしました。これにより「てんふぶのヤベー2人」などの特殊召喚が確実に動作するようになりました。
- **相手側の特殊召喚演出**: 特殊召喚の検知ロジックを全プレイヤーに拡張し、相手のカードが場に出た際も専用の出現アニメーションが再生されるようにしました。
- **BGMのランダム選択と重複防止**: 'Jade Moon.mp3' を追加し、前回プレイした曲が連続して選ばれないロジック（`sessionStorage`使用）を実装しました。
- **再戦（Rematch）機能の刷新**: ページリロードを避け、コイントスからシームレスに再戦できるようにしました。また、再戦時に前回の演出（ダメージ数字など）が残らないよう各ステートを徹底的に初期化します。
- **スペルエフェクトの修正**: 画像読み込みエラーが発生していたスペル用のパーティクルを、CSSベースの美しく輝くアニメーションに置き換えました。
- **オーバーキル表示の実装**: 体力が少ない相手に大ダメージを与えた際、実際に与えた数値が表示され、破壊されるまでの一瞬、体力がマイナス値（例: -2）になるリアリティのある挙動に変更しました。
- **シーケンスの整合性**: `isProcessingEffect` と `processingHandledRef` により、演出が完全に完了するまで次の効果が開始されないことを保証しました。
- **CPUレスポンスの改善**: ダメージ等のアニメーションを伴わない効果（バフ、PP回復等）の待機時間を大幅に短縮（1200ms -> 50ms）。これにより、CPUが連続して行うロジック処理が高速化されました。
- **デッドロックの解消**: `setIsProcessingEffect(false)` を `RESOLVE_EFFECT` のディスパッチより前に行う、あるいはタイマーを適切に管理することで、状態更新が詰まってアニメーションが止まる問題を解決しました。
- **茶トラの演出**: カード生成演出が途中で途切れたり、次の効果が先に表示されたりする問題を解消。生成されたカードが手札に飛んでいく様子が正しく連続して表示されます。

### 5. その他のビジュアル・UI改善
- **進化対象選択**: マーカー（点線円）がカードの正確な中心に表示されるように座標計算を修正しました。
- **ドラッグ矢印**: 進化/超進化時の対象選択矢印に強力なグロー（発光・ぼかし）を適用し、くっきりした線ではなく「光の帯」に見えるように質感を向上させました。
- **スペル描画**: スペル使用時にカード上部にノイズ（名前バーなど）が表示されていた問題を、カードの表示モードを最適化することで修正しました。

## 動作確認項目
- [ ] フォロワーをプレイした際、盤面上の正しいスロットに吸い込まれるように移動するか
- [ ] 中央でカードがしっかり停滞し、内容を確認できるか
- [ ] 中央から盤面への移動がスピーディで、メリハリが感じられるか
- [x] ビジュアルの細かな修正 (マーカー位置、矢印グロー、スペル描画ミス) <!-- id: 16 -->
- [x] スペルプレイ時のパーティクル表示エラーの修正 <!-- id: 17 -->
- [x] オーバーキル時のダメージ数値表示（マイナス表示）の改善 <!-- id: 18 -->
- [x] 再戦（Rematch）機能の安定化（演出リセットとBGMの復旧） <!-- id: 19 -->
- [ ] 演出の最終確認と微調整
- [ ] 残っている Lint エラーの解消
演出処理の順次実行 (isProcessingEffect による制御)
- [x] CPUターンの遅延解消 (非演出効果の高速化)
- [x] カード追加演出 (茶トラ等) のシーケンス安定化
- [ ] 進化時、発光した状態で一瞬「溜め」があり、その後素早く盤面に戻るか
