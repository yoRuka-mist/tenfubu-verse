# 進化後フォロワーが攻撃できない不具合の修正

## 問題の原因
進化後フォロワーが「たまに」攻撃できなくなる不具合は、**オブジェクト参照の問題**が原因でした。

### 具体的な問題点
1. **シャローコピーによる参照共有**
   - `board: [...newState.players.p1.board]`は配列は新しいが、配列内のカードオブジェクトは元の参照
   - 進化時に`follower.canAttack = true`を設定しても、参照が共有されているため状態が不安定

2. **passiveAbilities配列の参照共有**
   - `const passives = follower.passiveAbilities || []`で既存の配列を直接変更
   - 複数の状態が同じ配列を参照し、意図しない副作用が発生

3. **タイミングの問題**
   - 進化アニメーション中や効果処理中に状態が複数回コピーされる
   - 参照が共有されているため、どの時点の変更が反映されるか不定

## 修正内容

### 1. EVOLVE処理のディープコピー ✅
```typescript
board: newState.players.p1.board.map(c => c ? { 
    ...c, 
    passiveAbilities: c.passiveAbilities ? [...c.passiveAbilities] : undefined 
} : null)
```
- ボードカードオブジェクトを完全にコピー
- `passiveAbilities`配列も新しい配列として作成
- 各カードが独立したオブジェクトになる

### 2. ATTACK処理のディープコピー ✅
- EVOLVE処理と同様に、ボードカードを完全にコピー
- `canAttack`フラグの変更が確実に反映される

### 3. passiveAbilities配列の新規作成 ✅
```typescript
// 超進化時
const passives = [...(follower.passiveAbilities || [])];

// 通常進化時
const currentPassives = [...(follower.passiveAbilities || [])];
```
- 既存の配列を直接変更せず、常に新しい配列を作成
- 参照の共有を完全に排除

## 修正の効果
- **進化後のcanAttackフラグが確実に`true`になる**
- **進化時に追加されるRUSH能力が確実に反映される**
- **状態の独立性が保証され、タイミングによる不具合が解消される**
- **「たまに発生する」不具合が完全に解消される**

## テスト推奨項目
1. 通常進化後に即座に攻撃できるか
2. 超進化後に即座に攻撃できるか
3. 複数のフォロワーを連続で進化させても問題ないか
4. 進化アニメーション中に他の操作をしても問題ないか
5. オンライン対戦でも正しく動作するか
